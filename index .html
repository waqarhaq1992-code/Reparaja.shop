import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, addDoc } from 'firebase/firestore';
import { getAuth, signInWithCustomToken, signInAnonymously } from 'firebase/auth';

// Define Firebase variables using the provided global variables
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Main App component
export default function App() {
  // State for form data
  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    email: '',
    issue: '',
  });

  // State for Firebase services
  const [db, setDb] = useState(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showSuccessModal, setShowSuccessModal] = useState(false);

  // Initialize Firebase and authenticate the user
  useEffect(() => {
    async function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const auth = getAuth(app);

        // Sign in with the provided custom token or anonymously
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        setDb(firestore);
        console.log("Firebase initialized and user authenticated.");
      } catch (error) {
        console.error("Error initializing Firebase:", error);
      }
    }

    initFirebase();
  }, []);

  // Handle form input changes
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData({ ...formData, [name]: value });
  };

  // Handle form submission and save data to Firestore
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!db) {
      console.error("Firestore is not initialized.");
      return;
    }

    setIsSubmitting(true);
    try {
      // Define the collection path for public data
      const contactRequestsCollection = collection(db, `artifacts/${appId}/public/data/repara_ja_contacts`);

      // Add a new document with the form data
      await addDoc(contactRequestsCollection, {
        ...formData,
        timestamp: new Date(),
      });

      console.log('Form data submitted to Firestore successfully.');

      // Show the success modal
      setShowSuccessModal(true);

      // Reset the form
      setFormData({
        name: '',
        phone: '',
        email: '',
        issue: '',
      });
    } catch (error) {
      console.error('Error submitting form to Firestore:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
      {/* Hero Section */}
      <header className="relative flex min-h-screen items-center justify-center bg-gray-900 bg-cover bg-center text-white" style={{ backgroundImage: 'url(https://placehold.co/1200x800/2563EB/ffffff?text=Repara+J%C3%A1+Website)' }}>
        <div className="absolute inset-0 bg-black opacity-60"></div>
        <div className="relative z-10 p-6 text-center">
          <h1 className="text-4xl sm:text-5xl lg:text-7xl font-extrabold tracking-tight mb-4">
            Repara Já
          </h1>
          <p className="text-lg sm:text-xl lg:text-2xl font-light mb-8 max-w-2xl mx-auto">
            O seu telemóvel reparado sem sair de casa.
            <br />
            Recolhemos ➡️ Reparamos ➡️ Entregamos.
          </p>
          <a href="#contact" className="inline-block bg-blue-500 hover:bg-blue-600 transition-colors duration-300 text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105">
            Agendar Reparação
          </a>
        </div>
      </header>

      <main>
        {/* Process Section */}
        <section className="py-16 md:py-24 bg-white">
          <div className="container mx-auto px-4 md:px-8">
            <h2 className="text-3xl sm:text-4xl font-bold text-center mb-12 text-gray-900">Como Funciona</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
              {/* Step 1: We Collect */}
              <div className="flex flex-col items-center p-6 bg-blue-50 rounded-lg shadow-md transition-all duration-300 hover:shadow-xl">
                <div className="mb-4">
                  <span className="text-4xl text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-truck">
                      <path d="M10 17h6v-2h-6v2Z" />
                      <rect width="18" height="12" x="2" y="5" rx="2" />
                      <path d="M12 5v-2" />
                      <path d="M18 5v-2" />
                      <path d="M14 5v-2" />
                      <circle cx="7" cy="18" r="2" />
                      <circle cx="17" cy="18" r="2" />
                    </svg>
                  </span>
                </div>
                <h3 className="text-xl font-semibold mb-2 text-gray-900">Nós Recolhemos</h3>
                <p className="text-gray-600">
                  Agende a recolha do seu telemóvel à sua porta, em qualquer lugar.
                </p>
              </div>

              {/* Step 2: We Repair */}
              <div className="flex flex-col items-center p-6 bg-blue-50 rounded-lg shadow-md transition-all duration-300 hover:shadow-xl">
                <div className="mb-4">
                  <span className="text-4xl text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-wrench">
                      <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.77 3.77Z" />
                      <path d="m14.7 6.3 1.6 1.6" />
                    </svg>
                  </span>
                </div>
                <h3 className="text-xl font-semibold mb-2 text-gray-900">Nós Reparamos</h3>
                <p className="text-gray-600">
                  A nossa equipa de especialistas repara o seu dispositivo com peças de alta qualidade.
                </p>
              </div>

              {/* Step 3: We Deliver */}
              <div className="flex flex-col items-center p-6 bg-blue-50 rounded-lg shadow-md transition-all duration-300 hover:shadow-xl">
                <div className="mb-4">
                  <span className="text-4xl text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-box">
                      <path d="M21 8.25V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8.25" />
                      <path d="m7 11l4.242 4.243a1 1 0 0 0 1.415 0L17 11" />
                      <path d="m11 11h1" />
                      <path d="m3 8.25v-3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v3" />
                    </svg>
                  </span>
                </div>
                <h3 className="text-xl font-semibold mb-2 text-gray-900">Nós Entregamos</h3>
                <p className="text-gray-600">
                  O seu telemóvel é entregue de volta à sua porta, pronto a usar.
                </p>
              </div>
            </div>
          </div>
        </section>

        {/* Services Section */}
        <section className="py-16 md:py-24 bg-gray-50" id="services">
          <div className="container mx-auto px-4 md:px-8">
            <h2 className="text-3xl sm:text-4xl font-bold text-center mb-12 text-gray-900">Os Nossos Serviços</h2>
            <div className="max-w-3xl mx-auto">
              <ul className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center text-lg text-gray-700">
                <li className="p-4 bg-white rounded-lg shadow-sm transform transition-transform hover:scale-105">
                  Reparação de Ecrã
                </li>
                <li className="p-4 bg-white rounded-lg shadow-sm transform transition-transform hover:scale-105">
                  Substituição de Bateria
                </li>
                <li className="p-4 bg-white rounded-lg shadow-sm transform transition-transform hover:scale-105">
                  Reparação de Câmera
                </li>
                <li className="p-4 bg-white rounded-lg shadow-sm transform transition-transform hover:scale-105">
                  Reparação de Danos por Água
                </li>
                <li className="p-4 bg-white rounded-lg shadow-sm transform transition-transform hover:scale-105">
                  Problemas de Carregamento
                </li>
                <li className="p-4 bg-white rounded-lg shadow-sm transform transition-transform hover:scale-105">
                  Diagnóstico Completo
                </li>
              </ul>
            </div>
          </div>
        </section>

        {/* Contact Form Section */}
        <section className="py-16 md:py-24 bg-blue-500" id="contact">
          <div className="container mx-auto px-4 md:px-8">
            <h2 className="text-3xl sm:text-4xl font-bold text-center mb-12 text-white">Contacte-nos</h2>
            <div className="bg-white rounded-lg p-8 md:p-12 shadow-2xl max-w-lg mx-auto">
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label htmlFor="name" className="block text-sm font-medium text-gray-700">
                    Nome Completo
                  </label>
                  <input
                    type="text"
                    id="name"
                    name="name"
                    value={formData.name}
                    onChange={handleInputChange}
                    required
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label htmlFor="phone" className="block text-sm font-medium text-gray-700">
                    Número de Telemóvel
                  </label>
                  <input
                    type="tel"
                    id="phone"
                    name="phone"
                    value={formData.phone}
                    onChange={handleInputChange}
                    required
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label htmlFor="email" className="block text-sm font-medium text-gray-700">
                    Email
                  </label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    value={formData.email}
                    onChange={handleInputChange}
                    required
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label htmlFor="issue" className="block text-sm font-medium text-gray-700">
                    Descrição do Problema
                  </label>
                  <textarea
                    id="issue"
                    name="issue"
                    rows="4"
                    value={formData.issue}
                    onChange={handleInputChange}
                    required
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  />
                </div>
                <div className="flex justify-center">
                  <button
                    type="submit"
                    disabled={isSubmitting}
                    className={`inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-sm font-medium rounded-full text-white ${isSubmitting ? 'bg-blue-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300 transform hover:scale-105`}
                  >
                    {isSubmitting ? 'A Enviar...' : 'Agendar Reparação'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>

        {/* Success Modal */}
        {showSuccessModal && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg p-6 max-w-sm mx-auto shadow-xl text-center">
              <h3 className="text-xl font-bold mb-4 text-green-600">Obrigado!</h3>
              <p className="text-gray-700 mb-6">
                A sua solicitação de reparação foi enviada com sucesso. Entraremos em contacto em breve.
              </p>
              <button
                onClick={() => setShowSuccessModal(false)}
                className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full"
              >
                Fechar
              </button>
            </div>
          </div>
        )}
      </main>

      {/* Footer */}
      <footer className="bg-gray-900 text-gray-400 py-8">
        <div className="container mx-auto px-4 text-center">
          <p>© {new Date().getFullYear()} Repara Já. Todos os direitos reservados.</p>
        </div>
      </footer>
    </div>
  );
}


